

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>__PyRPL.acs_property &mdash; PyRPL 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="PyRPL 0.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">PyRPL 0.0.1 documentation</a></div>
        <div class="rel">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for __PyRPL.acs_property</h1><div class="highlight"><pre>
<span class="c">#! /usr/local/bin/python</span>
<span class="kn">import</span> <span class="nn">pyodbc</span><span class="o">,</span><span class="nn">sqlite3</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">codecs</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">types</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span><span class="n">localtime</span>

<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">timed</span><span class="p">,</span> <span class="n">fixUnicode</span><span class="p">,</span> <span class="n">removeNulls</span><span class="p">,</span> <span class="n">fixStreetAddress</span> 


<div class="viewcode-block" id="Property"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property">[docs]</a><span class="k">class</span> <span class="nc">Property</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    base property class that will pull all basic property informationfrom</span>
<span class="sd">    the ACS database.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dbname</span><span class="o">=</span><span class="s">&#39;property.sqlite&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates the sqlite3 connections to the property database and the ODBC</span>
<span class="sd">        connection to the ACS system. also sets various variables that will</span>
<span class="sd">        be reused throuhout the other mehtods.</span>
<span class="sd">        this portion also creates the basic database structure for the</span>
<span class="sd">        property.sqlite database if it does not exist</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#set the name and path of the local database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)]</span> <span class="o">+</span><span class="s">&#39;/files/&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)]</span> <span class="o">+</span><span class="s">&#39;/sql/property/&#39;</span>
        <span class="k">except</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&quot;/sql/property/&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/files/&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span>    
        <span class="c">#determine OS type and use the correct driver to connect to ACS</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span><span class="s">&#39;posix&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">r&quot;driver=FreeTDS;server=ventacs;Database=acslrs;uid=lrmi_dba;pwd=Sysadmin1;port=2152;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">r&#39;driver={SQL Server};server=</span><span class="si">%s</span><span class="s">\acslrs;Database=ACSLRS;uid=lrmi_dba;pwd=</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s">&quot;ventacs&quot;</span><span class="p">,</span><span class="s">&quot;Sysadmin1&quot;</span><span class="p">))</span><span class="c">#connection to production data on ACS server</span>
            <span class="c">#self.conn = pyodbc.connect(r&#39;driver={SQL Server};server=%s\acslrs;Database=ACSLRS;uid=lrmi_dba;pwd=%s&#39;%(&quot;testacs&quot;,&quot;Sysadmin1&quot;))#connection to test data on ACS server</span>

        <span class="c">#set the conenctions to the local and ACS database    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c">#get the year effective dates from ACS</span>
        <span class="n">tempyears</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select rollyear,eff_date,current_flag from ao_appraisal_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span> <span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">tempyears</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">year</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span><span class="s">&quot;Y&quot;</span><span class="p">:</span>
            <span class="n">year</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">year</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
          <span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;00:00:00&#39;</span><span class="p">,</span><span class="s">&#39;23:59:59&#39;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">year</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="mi">2009</span><span class="p">]</span> <span class="o">=</span><span class="p">(</span><span class="s">&#39;2009-11-14 00:00:00&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="c">#create the portal data table for property</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_Property.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        
        <span class="c">#create the portal data table for Zoning</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_Zoning.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>      

        <span class="c">#create the portal data table for Name</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_Name.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        
        <span class="c">#create the portal data table for address</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_Address.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        
        <span class="c">#create the portal data table for Documents</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_Document.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        
        <span class="c">#create portal data table for comments</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_Comment.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
                           
        <span class="c">#create Land Class Values table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_LandClass.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
                                  
        <span class="c">#create UTA code table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_UTA.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        
        <span class="c">#create the QQ lat long table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_QQ_LatLong.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#create db_info table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_db_info.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#verify initial entry</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from db_info&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="c">#print type(r)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">NoneType</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;insert into db_info values(&#39;property&#39;,&#39;0.7&#39;,&#39;2012-04-30 16:24:00.000&#39;,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="c">###########################</span>
    <span class="c">#   UTILITY FUNCTIONS     #</span>
    <span class="c">###########################</span>
<div class="viewcode-block" id="Property.getColumns"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getColumns">[docs]</a>    <span class="k">def</span> <span class="nf">getColumns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pull data table information from sqlite databases&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">ssql</span> <span class="o">=</span><span class="s">&quot;SELECT * FROM INFORMATION_SCHEMA.Columns where TABLE_NAME = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> 
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span>
                <span class="n">x</span> <span class="o">=</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">result</span>
      </div>
    <span class="nd">@timed</span>    
    <span class="c">#function to get base property info</span>
<div class="viewcode-block" id="Property.getProperty"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getProperty">[docs]</a>    <span class="k">def</span> <span class="nf">getProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">curyear</span> <span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        rollyear is the current rollyear.  this number is used to find the</span>
<span class="sd">        range of effective dates for a roll year.  curyear is the current</span>
<span class="sd">        year flag, if set to true (default) it will use a diffent querystring</span>
<span class="sd">        as the current roll year always uses the most recent data. return</span>
<span class="sd">        the sqlite3 tuple (each property in tuple format)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
        <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>
        
        <span class="c">#please note the way to get the correct most recent data for a year</span>
        <span class="c">#is to use the max(effective_date) and use the apprasal year table</span>
        <span class="c">#to get the effective date for a roll year also you must check the</span>
        <span class="c">#appropriate part table to ensure it is the most current part record.</span>
        
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_Property.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span>
      </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setProperty"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setProperty">[docs]</a>    <span class="k">def</span> <span class="nf">setProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      update basic property data (r) for portal. r is a tuple of records in tuples</span>
<span class="sd">      rollyear is the year. All data will be inserted into the newProperty</span>
<span class="sd">      table for the four digit rollyear. return the  count of the records</span>
<span class="sd">      updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#always start with a clean table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete  from newProperty where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="c">#begin insert of data for roll year</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="s">&#39;0&#39;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c">#ensures that the correct unicode type is used as there are invalid utf-8 codes in the results from the cp1252 data in  the ACS mssql database </span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;insert into newProperty values (</span><span class="si">%s</span><span class="s">,0,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,0.00,0.00,0.00,0.00,0.00,</span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>        
            <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">rcount</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.getParcel"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getParcel">[docs]</a>    <span class="k">def</span> <span class="nf">getParcel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the acres and legal data for all properties in a four digit roll year</span>
<span class="sd">      from ACS. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>      
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_Parcel.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setParcel"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setParcel">[docs]</a>    <span class="k">def</span> <span class="nf">setParcel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the parcel data (legal and acres) for each property in the data set</span>
<span class="sd">      for a four digit roll year in the NewProperty table return the count of</span>
<span class="sd">      the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#begin insert of data for roll year</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="c">#update the newProperty table with the data based on property part oid and the roll year</span>
        <span class="n">acre</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">acre</span> <span class="o">==</span><span class="s">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">acre</span><span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">acre</span><span class="o">=</span><span class="mf">0.00</span>          
        <span class="n">legal</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">legal</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">legal</span> <span class="o">=</span> <span class="s">u&#39;N/A&#39;</span>
        <span class="n">legal</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">legal</span><span class="p">)</span>
        <span class="n">legal</span> <span class="o">=</span> <span class="n">legal</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">legal</span> <span class="o">=</span> <span class="n">legal</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">legal</span> <span class="o">=</span> <span class="n">legal</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">legal</span> <span class="o">=</span> <span class="n">legal</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span>
          <span class="n">subdiv</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">subdiv</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="c">#the sql query is an update to the existing data in the local database</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Update newProperty set acres=</span><span class="si">%s</span><span class="s">,legal=&quot;</span><span class="si">%s</span><span class="s">&quot;,subdivision=&quot;</span><span class="si">%s</span><span class="s">&quot; where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and rollyear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">acre</span><span class="p">,</span><span class="n">legal</span><span class="p">,</span><span class="n">subdiv</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">ssql</span>
          <span class="k">print</span> <span class="n">e</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">rcount</span>  
                      
    <span class="c">#get zoining records for a parcel</span></div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.getZoning"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getZoning">[docs]</a>    <span class="k">def</span> <span class="nf">getZoning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the zoning data for all properties in a four digit roll year</span>
<span class="sd">      from ACS. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>        
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>
      <span class="c">#setup logic for current year vs old years</span>
      <span class="c">#print startyear,endyear</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_Zoning.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setZoning"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setZoning">[docs]</a>    <span class="k">def</span> <span class="nf">setZoning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the zoning data (r) in the newZoning table for a four digit roll year</span>
<span class="sd">      return the count of the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#always start with a clean table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete  from newZoning  where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="c">#begin insert of data for roll year</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ecount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">edate</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">zc</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">zc</span><span class="p">:</span>
              <span class="n">zc</span> <span class="o">=</span> <span class="s">u&#39;N/A&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pin</span><span class="p">:</span>
              <span class="n">pin</span> <span class="o">=</span><span class="s">&#39;0000000000000000000&#39;</span>
              <span class="k">print</span> <span class="n">i</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;insert into newZoning values (&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span><span class="n">edate</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">zc</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
              <span class="k">print</span> <span class="n">e</span>
              <span class="k">print</span> <span class="n">i</span>
              <span class="k">print</span> <span class="n">ssql</span>
              <span class="n">ecount</span> <span class="o">=</span> <span class="n">ecount</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">print</span> <span class="s">&quot;zoning errors:&quot;</span><span class="p">,</span><span class="n">ecount</span>
      <span class="k">return</span> <span class="n">rcount</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.getName"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getName">[docs]</a>    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the name data for each property in the data set for a four digit</span>
<span class="sd">      roll year in the NewProperty table return the count of the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>

      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_Name.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setName"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setName">[docs]</a>    <span class="k">def</span> <span class="nf">setName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the name data (r) in the newName table for a four digit roll year</span>
<span class="sd">      this data will also include the mailing address for the name</span>
<span class="sd">      return the count of the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#always start with a clean table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete  from newName  where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ecount</span> <span class="o">=</span><span class="mi">0</span> 
      <span class="c">#begin insert of data for roll year </span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        
        <span class="c">#clean nulls</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
          <span class="n">j</span> <span class="o">=</span> <span class="n">removeNulls</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
          <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">oid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">edate</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
        <span class="n">tpre</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">firstname</span> <span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">lastname</span> <span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">tsuf</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="c">#get street address values</span>
        <span class="n">addr</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">27</span><span class="p">):</span>
          <span class="n">addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">fixStreetAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="c">#call the utility function to create the street address</span>
        <span class="n">streetnumber</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">street</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>       
        <span class="n">streetaddress</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       
        <span class="n">city</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">zipcode</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">country</span> <span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>        
        <span class="n">mailto</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span><span class="n">edate</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">tpre</span><span class="p">,</span><span class="n">firstname</span><span class="p">,</span><span class="n">lastname</span><span class="p">,</span><span class="n">tsuf</span><span class="p">,</span><span class="n">streetnumber</span><span class="p">,</span><span class="n">street</span><span class="p">,</span><span class="n">unit</span><span class="p">,</span><span class="n">streetaddress</span><span class="p">,</span><span class="n">city</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">zipcode</span><span class="p">,</span><span class="n">country</span><span class="p">,</span><span class="n">role</span><span class="p">,</span><span class="n">mailto</span><span class="p">,</span><span class="n">percentage</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;insert into newName values(</span><span class="si">%s</span><span class="s">)&quot;</span><span class="o">%</span><span class="n">s</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">e</span>
          <span class="k">print</span> <span class="n">i</span>
          <span class="n">ecount</span>  <span class="o">=</span> <span class="n">ecount</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">print</span> <span class="p">(</span><span class="n">rcount</span><span class="p">)</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
          
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>    
      <span class="k">print</span> <span class="s">&#39;name total errors =&#39;</span><span class="p">,</span><span class="n">ecount</span>
      <span class="k">return</span> <span class="n">rcount</span>
</div>
<div class="viewcode-block" id="Property.getAddress"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getAddress">[docs]</a>    <span class="k">def</span> <span class="nf">getAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the address data for all properties in a four digit roll year</span>
<span class="sd">      from ACS. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>
      <span class="c">#setup logic for current year vs old years</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_Address.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setAddress"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setAddress">[docs]</a>    <span class="k">def</span> <span class="nf">setAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the address data (r) in the newAddress table for a four digit roll year</span>
<span class="sd">      return the count of the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="c">#always start with a clean table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete  from newAddress  where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>      
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ecount</span> <span class="o">=</span><span class="mi">0</span> 
      <span class="c">#begin insert of data for roll year </span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>        
        <span class="c">#clean nulls</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
          <span class="n">j</span> <span class="o">=</span> <span class="n">removeNulls</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
          <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">oid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">edate</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
          <span class="c">#get street address values</span>
        <span class="n">addr</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">12</span><span class="p">):</span>
          <span class="n">addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">fixStreetAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">streetnumber</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">street</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>       
        <span class="n">streetaddress</span> <span class="o">=</span> <span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       
        <span class="n">city</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
        <span class="n">zipcode</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span><span class="n">edate</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">streetnumber</span><span class="p">,</span><span class="n">street</span><span class="p">,</span><span class="n">unit</span><span class="p">,</span><span class="n">streetaddress</span><span class="p">,</span><span class="n">city</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">zipcode</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        
        <span class="n">ssql</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;insert into newAddress values(</span><span class="si">%s</span><span class="s">)&quot;</span><span class="o">%</span><span class="n">s</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">e</span>
          <span class="k">print</span> <span class="n">i</span>
          <span class="n">ecount</span>  <span class="o">=</span> <span class="n">ecount</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">print</span> <span class="p">(</span><span class="n">rcount</span><span class="p">)</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
          
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>    
      <span class="k">print</span> <span class="s">&#39;address total errors =&#39;</span><span class="p">,</span><span class="n">ecount</span>
      <span class="k">return</span> <span class="n">rcount</span>
        </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.getDocument"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getDocument">[docs]</a>    <span class="k">def</span> <span class="nf">getDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the document data for all properties in a four digit roll year</span>
<span class="sd">      from ACS. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_Document.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setDocument"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setDocument">[docs]</a>    <span class="k">def</span> <span class="nf">setDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the document data for each property in the data set</span>
<span class="sd">      for a four digit roll year in the NewProperty table return the count of</span>
<span class="sd">      the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#clear the doucment table. </span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete  from newDocument  where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="c">#begin insert of data for roll year</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="c">#get the document number for each record</span>
      <span class="n">documents</span> <span class="o">=</span><span class="p">{}</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span>
          <span class="n">docnumber</span> <span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">docnumber</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

        <span class="c">#verify most current doc</span>
        <span class="k">if</span> <span class="n">documents</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
          <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">documents</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">documents</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">docnumber</span><span class="p">,</span><span class="n">rollyear</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">documents</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">docnumber</span><span class="p">,</span><span class="n">rollyear</span><span class="p">]</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;insert into newDocument values(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">docnumber</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">i</span>
          <span class="k">print</span> <span class="n">e</span>
          <span class="k">print</span> <span class="n">ssql</span>
          <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;err&#39;</span><span class="p">)</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">documents</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
        <span class="c">#update the newDocument table with the data based on PIN and the roll year      </span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Update newProperty set DocumentNumber=&#39;</span><span class="si">%s</span><span class="s">&#39; where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and rollyear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="c">#print ssql</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>          
          <span class="k">print</span> <span class="n">ssql</span>
          <span class="k">print</span> <span class="n">e</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>        
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="c">#print rcount</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">rcount</span>  
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.getComments"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getComments">[docs]</a>    <span class="k">def</span> <span class="nf">getComments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the comments data for all properties in a four digit roll year</span>
<span class="sd">      from ACS. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>
      <span class="c">#setup logic for current year vs old years</span>
      <span class="c">#print startyear,endyear</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_Comment.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setComments"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setComments">[docs]</a>    <span class="k">def</span> <span class="nf">setComments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the comments data (r) in the newComment table for a four digit roll year</span>
<span class="sd">      return the count of the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete  from newComment  where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="c">#begin insert of data for roll year</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="c">#get the document number for each record</span>
      <span class="n">comments</span> <span class="o">=</span><span class="p">{}</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ssql</span> <span class="o">=</span><span class="s">&quot;&quot;&quot;insert into newComment values(&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="c">#fix issues with unicode </span>
        <span class="n">ssql</span> <span class="o">=</span><span class="n">fixUnicode</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span> 
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">e</span>
          <span class="k">print</span> <span class="n">ssql</span>
        <span class="k">if</span> <span class="n">comments</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
          <span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">+</span><span class="s">&#39;;</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="c">#update the comments in the newproperty table by PIN and rollyear</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">comments</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;update newProperty set history=&quot;</span><span class="si">%s</span><span class="s">&quot; where pin =&quot;</span><span class="si">%s</span><span class="s">&quot; and rollyear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">e</span>
          <span class="k">print</span> <span class="n">ssql</span>
          <span class="nb">raw_input</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">rcount</span>
                                                                           </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.getLotteryCredit"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getLotteryCredit">[docs]</a>    <span class="k">def</span> <span class="nf">getLotteryCredit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the lotery credit for all properties in a four digit roll year</span>
<span class="sd">      from ACS. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#get data from 1 year prior for parcel</span>
      
      <span class="c">#the start and end year format are different for billing side than ao this changes it to reflect an entire calendar year</span>
      <span class="c">#when using data from the BCO side of ACS searching the data for a tax year does not always involve the max(effective_date) &lt;= apprasal year effective date</span>
      <span class="c">#an entire calendar year is used for the tax year as taxes are collected all year long and can be generated at any time after data is ready form the AO side</span>
      <span class="n">startdate</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">-1-1 00:00:00&#39;</span><span class="o">%</span><span class="n">endyear</span>
      <span class="n">enddate</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">-12-31 23:59:59&#39;</span><span class="o">%</span><span class="n">endyear</span>

      <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_LotteryCredit.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%e</span><span class="s">nddate%&#39;</span><span class="p">,</span><span class="n">enddate</span><span class="p">)</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">tartdate%&#39;</span><span class="p">,</span><span class="n">startdate</span><span class="p">)</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setLotteryCredit"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setLotteryCredit">[docs]</a>    <span class="k">def</span> <span class="nf">setLotteryCredit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the lottery credit for each property in the data set</span>
<span class="sd">      for a four digit roll year in the NewProperty table return the count of</span>
<span class="sd">      the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#begin insert of data for roll year</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="c">#update the newProperty table with the data based on pin and the roll year       </span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;Update newProperty set LotteryCredit=</span><span class="si">%s</span><span class="s"> where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and rollyear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">ssql</span>
          <span class="k">print</span> <span class="n">e</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">rcount</span>
    </div>
    <span class="nd">@timed</span>    
<div class="viewcode-block" id="Property.getsetTaxes"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getsetTaxes">[docs]</a>    <span class="k">def</span> <span class="nf">getsetTaxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the tax data for all properties in a four digit roll year</span>
<span class="sd">      from ACS. then current year and previous year taxes for each</span>
<span class="sd">      property. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>

      <span class="n">prevyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span> <span class="mi">2</span> <span class="c">#two years prior should be used for property data </span>
      <span class="n">curryear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span> <span class="mi">1</span> <span class="c">#one year prior is used for current taxes as the parcel will have no taxes until they are done at the end of the year</span>
      
      <span class="c">#get previous year taxes and add to taxes dictionary</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select b_original_levy,b_parcel_id from lr_bill_attributes where b_tax_year=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="n">prevyear</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="c">#set previous year taxes</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;update newProperty set PreviousYearTaxes = </span><span class="si">%s</span><span class="s"> where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and rollyear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
  
      <span class="c">#get current year taxes and add to taxes dictionary</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select b_original_levy,b_parcel_id from lr_bill_attributes where b_tax_year=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="n">curryear</span>
      
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="c">#set current year taxes</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;update newProperty set CurrentYearTaxes =</span><span class="si">%s</span><span class="s"> where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and rollyear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>               

      <span class="k">return</span> <span class="n">rcount</span></div>
<div class="viewcode-block" id="Property.getLandClass"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getLandClass">[docs]</a>    <span class="k">def</span> <span class="nf">getLandClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span> <span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get the land class data for all properties in a four digit roll year</span>
<span class="sd">      from ACS. return sqlite3 tuple</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      <span class="n">startyear</span> <span class="o">=</span> <span class="n">rollyear</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#roll year starts in November of the previous year and goes to November of the current year</span>
      <span class="n">endyear</span> <span class="o">=</span> <span class="n">rollyear</span>
      <span class="c">#setup logic for current year vs old years</span>
      <span class="c">#print startyear,endyear</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Get_LandClass.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">ollyear%&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rollyear</span><span class="p">[</span><span class="n">endyear</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">r</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.setLandClass"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.setLandClass">[docs]</a>    <span class="k">def</span> <span class="nf">setLandClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Update the land class data for each property in the data set</span>
<span class="sd">      for a four digit roll year in the newLandClass table return the count of</span>
<span class="sd">      the records updated</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#start with a clean table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete  from newLandClass  where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="c">#begin insert of data for roll year</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ecount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">edate</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">acres</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">landv</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">impv</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">pin</span><span class="p">:</span>
              <span class="n">pin</span> <span class="o">=</span><span class="s">&#39;0000000000000000000&#39;</span>
              <span class="k">print</span> <span class="n">i</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;insert into newLandClass values (&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span><span class="n">edate</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">lc</span><span class="p">,</span><span class="n">acres</span><span class="p">,</span><span class="n">landv</span><span class="p">,</span><span class="n">impv</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
              <span class="k">print</span> <span class="n">e</span>
              <span class="k">print</span> <span class="n">i</span>
              <span class="k">print</span> <span class="n">ssql</span>
              <span class="n">ecount</span> <span class="o">=</span> <span class="n">ecount</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">rcount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">print</span> <span class="s">&quot;Land Class errors:&quot;</span><span class="p">,</span><span class="n">ecount</span>
      <span class="k">return</span> <span class="n">rcount</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.updateSubdivision"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.updateSubdivision">[docs]</a>    <span class="k">def</span> <span class="nf">updateSubdivision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get subdivision data for all properties in a fout digit roll year from</span>
<span class="sd">      ACS. then update all properties with the data set for the roll year</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select * from lr_l_plat&quot;&quot;&quot;</span>
      <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="n">subdiv</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subdiv</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
          <span class="n">subdiv</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">ssql</span> <span class="o">=</span>  <span class="s">&quot;&quot;&quot;select pin,subdivision,legal,rollyear from newProperty where rollyear =</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="n">rollyear</span>
      <span class="c">#print ssql</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="c">#print len(r)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">subname</span> <span class="o">=</span><span class="s">&#39;&#39;</span>
        <span class="n">legal</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span><span class="s">&#39;&#39;</span><span class="p">:</span>
          <span class="n">tsub</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">subname</span> <span class="o">=</span> <span class="n">subdiv</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">subname</span><span class="p">:</span>
            <span class="n">subname</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update newProperty set subdivision=&quot;</span><span class="si">%s</span><span class="s">&quot; where pin=&quot;</span><span class="si">%s</span><span class="s">&quot; and rollyear=</span><span class="si">%s</span><span class="s">&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subname</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.getsetUTA"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getsetUTA">[docs]</a>    <span class="k">def</span> <span class="nf">getsetUTA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      get uta data in a fout digit roll year from ACS. then insert all</span>
<span class="sd">      records into tieh newUTA table by municiaplity and rollyear.</span>
<span class="sd">      return the total number of recorded added</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>        
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from newUTA where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="c">#raw_input(&#39;del&#39;)</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;select uta_code,descr,tax_year from lr_l_uta_codes where tax_year=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">rollyear</span>
      <span class="n">uta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">uta</span><span class="p">:</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;insert into newUTA values (&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="n">e</span>
          <span class="k">print</span> <span class="n">ssql</span>
      <span class="n">rcount</span> <span class="o">=</span> <span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">rcount</span>
    </div>
<div class="viewcode-block" id="Property.getsetLatLong"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getsetLatLong">[docs]</a>    <span class="k">def</span> <span class="nf">getsetLatLong</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      gets the PIN lat and long from the GIS spreadsheet and sets it for all</span>
<span class="sd">      rollyears for a PIN in newProperty. return a dictionary of properties</span>
<span class="sd">      by pin number with lat and long values</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#open the lat long file and read into dict</span>
      <span class="n">latlong</span><span class="o">=</span><span class="p">{}</span>
      <span class="n">dups</span><span class="o">=</span><span class="p">[]</span>
      <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">+</span><span class="s">&#39;latlong.txt&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
      <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latlong</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
          <span class="n">dups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">latlong</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;update newProperty set Latitude= &#39;</span><span class="si">%s</span><span class="s">&#39;, Longitude = &#39;</span><span class="si">%s</span><span class="s">&#39; where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c">#raw_input(ssql)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
          <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">print</span> <span class="n">ssql</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
          <span class="k">print</span> <span class="n">x</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="c">#fix missing latlong</span>
      <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select pin,latitude,longitude from newProperty&quot;&quot;&quot;</span>
      <span class="n">pins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> 
      <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">pins</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span><span class="s">&#39;0&#39;</span><span class="p">:</span>
          <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="n">trs</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
          <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select latitude,Longitude from qqlatlong where qqID=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">trs</span>
          <span class="n">latlong</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">latlong</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update newProperty set Latitude= &#39;</span><span class="si">%s</span><span class="s">&#39;, Longitude = &#39;</span><span class="si">%s</span><span class="s">&#39; where pin =&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">latlong</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">latlong</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">latlong</span>
</div>
<div class="viewcode-block" id="Property.getsetqq"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.getsetqq">[docs]</a>    <span class="k">def</span> <span class="nf">getsetqq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the long and lat from the __kml.kml file for centroid of qq&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;delete from qqlatlong&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="o">+</span><span class="s">&#39;__kml.kml&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">latlong</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">llflag</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">hit</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&lt;SimpleData name=&quot;DTRS&quot;&gt;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hit</span> <span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">trs</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span>
                <span class="n">llflag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">hit</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&gt;-9&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">llflag</span> <span class="ow">and</span> <span class="n">hit</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&gt;-9&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;/coordinates&quot;</span><span class="p">)]</span>
                <span class="n">llflag</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">latlong</span><span class="p">[</span><span class="n">trs</span><span class="p">]</span><span class="o">=</span><span class="n">s</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="c">#print trs</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;insert into qqlatlong values(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">trs</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">latlong</span><span class="p">)</span>
                    
    <span class="c">#########################################################</span>
    <span class="c">#  Main Functions                                       #</span>
    <span class="c">#########################################################</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Property.createRollYear"><a class="viewcode-back" href="../../acs_property.html#__PyRPL.acs_property.Property.createRollYear">[docs]</a>    <span class="k">def</span> <span class="nf">createRollYear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">year</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      creates the property data for a rollyear takes a four digit year for the</span>
<span class="sd">      roll year you wish to create.  if year is blank it defaults to the</span>
<span class="sd">      current year</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">#set the rollyear if not set</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">year</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
      
      <span class="k">print</span> <span class="s">&#39;do </span><span class="si">%s</span><span class="s"> rollyear&#39;</span><span class="o">%</span><span class="n">year</span>
      <span class="c">#get methods get data from the ACS database</span>
      
      <span class="c">#set methods take the data from the get method, format it and insert it</span>
      <span class="c">#into the appropriate table. usually the newProperty table </span>
      <span class="c">#for property data</span>
      
      <span class="c">#getset method get and insert data in one call. this is done for simple</span>
      <span class="c">#data retreival and inserts</span>
      
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsetUTA</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>     
      <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
      
      <span class="n">r</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getParcel</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setParcel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>

      <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocument</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setDocument</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>

      <span class="n">zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getZoning</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setZoning</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>

      <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
      
      <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAddress</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setAddress</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
      
      <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getComments</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setComments</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
      
      <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLandClass</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setLandClass</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
      
      <span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLotteryCredit</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">ok</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setLotteryCredit</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
      
      <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsetTaxes</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateSubdivision</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> is done&#39;</span><span class="o">%</span><span class="n">year</span><span class="p">)</span>
      
      <span class="c">#get and set quarter-quarter lat long</span>
      <span class="n">qq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsetqq</span><span class="p">()</span>
      <span class="c">#lat long assign to properties</span>
      <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsetLatLong</span><span class="p">()</span>
      <span class="c">#update db_info table</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;update db_info set lastupdate=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      
    </div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c">#this below sequence captures all data needed for gis from the beginning of the system thru 2012 roll year</span>
    <span class="c">#taxes may have to be looked at as the 2012 roll year does not have 2012 taxes as they will not be generated until near</span>
    <span class="c">#the end of the year.  the issue is that the 2012 assessment data needs to be displayed by GIS.  therefore when we begin</span>
    <span class="c">#to use the 2012 assessment year data the 2011 taxes should be used for the current taxes and the 2010 taxes as previous year</span>
    <span class="c">#until the 2012 taxes are ready.  at that point the 2012 taxes should be the current year taxes for 2012 data and 2011 for previous year</span>
    <span class="c">#this cycle will continue for each year in the same pattern ######### we need to find a way to automate this so the current year data will</span>
    <span class="c">#                                                                     always be in sync with the tax year#####</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">Property</span><span class="p">()</span>
    
    
    <span class="n">year</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2010</span><span class="p">,</span><span class="mi">2011</span><span class="p">,</span><span class="mi">2012</span><span class="p">,)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year</span><span class="p">:</span>
      <span class="n">z</span><span class="o">.</span><span class="n">createRollYear</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>       
    



    

            
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Base Modules.html">User Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Foundation Modules</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2012, Matt Kasfeldt.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html> 