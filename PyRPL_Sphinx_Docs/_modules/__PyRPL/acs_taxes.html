

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>__PyRPL.acs_taxes &mdash; PyRPL 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="PyRPL 0.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">PyRPL 0.0.1 documentation</a></div>
        <div class="rel">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for __PyRPL.acs_taxes</h1><div class="highlight"><pre>
<span class="c">#! /usr/local/bin/python</span>
<span class="kn">import</span> <span class="nn">pyodbc</span><span class="o">,</span><span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">timed</span><span class="p">,</span> <span class="n">fixUnicode</span><span class="p">,</span> <span class="n">removeNulls</span><span class="p">,</span> <span class="n">fixStreetAddress</span> 
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">getFields</span><span class="p">,</span> <span class="n">getHeader</span><span class="p">,</span> <span class="n">getDataFolders</span>

<div class="viewcode-block" id="Taxdata"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata">[docs]</a><span class="k">class</span> <span class="nc">Taxdata</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to create and update taxdata database. ensure property database is available</span>
<span class="sd">    Taxdata(path=&#39;PathToDB&#39;) path is fully qualified</span>
<span class="sd">    if path is blank use location of script</span>
<span class="sd">    dbname is always taxbill.sqlite</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dbname</span><span class="o">=</span><span class="s">&#39;taxbill.sqlite&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates the sqlite3 connections to the property database and the ODBC</span>
<span class="sd">        connection to the ACS system. also sets various variables that will</span>
<span class="sd">        be reused throuhout the other mehtods.</span>
<span class="sd">        this portion also creates the basic database structure for the</span>
<span class="sd">        property.sqlite database if it does not exist</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#set the name and path of the local database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)]</span> <span class="o">+</span><span class="s">&#39;/files/&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)]</span> <span class="o">+</span><span class="s">&#39;/sql/taxes/&#39;</span>
        <span class="k">except</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&quot;/sql/taxes/&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/files/&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstInstallment</span> <span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondInstallment</span><span class="o">=</span><span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">))</span> <span class="c">#create connection to local db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="c">#create cursor to local db</span>

        <span class="c">#determine OS type and use the correct driver</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span><span class="s">&#39;posix&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">r&quot;driver=FreeTDS;server=ventacs;Database=acslrs;uid=lrmi_dba;pwd=Sysadmin1;port=2152;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">r&#39;driver={SQL Server};server=</span><span class="si">%s</span><span class="s">\acslrs;Database=ACSLRS;uid=lrmi_dba;pwd=</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s">&quot;ventacs&quot;</span><span class="p">,</span><span class="s">&quot;Sysadmin1&quot;</span><span class="p">))</span><span class="c">#connection to production data on ACS server</span>
            <span class="c">#self.conn = pyodbc.connect(r&#39;driver={SQL Server};server=%s\acslrs;Database=ACSLRS;uid=lrmi_dba;pwd=%s&#39;%(&quot;testacs&quot;,&quot;Sysadmin1&quot;))#connection to test data on ACS server</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="c">#cursor for prodution data</span>

        <span class="c">#create connections to property database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/property.sqlite&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="c">#create connection to local db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="c">#create cursor to local db</span>

        <span class="c">#create the municipality tax data table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_MuniTaxData.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#create the uta tax info table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_utaTaxData.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#create the tid tax data info</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_tidTaxData.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#create the bill data table. this contains the tax bill data for the portal site</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_billData.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#create the legal data table</span>
        <span class="n">ssql</span> <span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_Legal.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c">#this will create the table to store the data from ACS tax bills for 2011 forward</span>
        <span class="c">#it will be used to create the record entries for the billData table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_ACStaxData.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c">#this will create the table to store the tax values from ACS tax bills 2011 forward</span>
        <span class="c">#it will be used to find the taxes, assessments, lottery credits and FDC fro the billData table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_ACStaxValues.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>

        <span class="c">#this will create the table to store the tax payments for a property</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_taxPayments.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>

        <span class="c">#create the muni name table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;Create Table if not exists MuniName (MuniNumber Text PRIMARY KEY, MuniName Text)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muniname</span> <span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muniname</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from MuniName&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from ao_l_pin_municipality&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into MuniName values(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muniname</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c">#create duplicate pin table</span>
        <span class="n">ssql</span><span class="o">=</span><span class="s">&quot;create table if not exists duplicatePin (OldPin text,ComputerNumber text,newPIN text,PRIMARY KEY(OldPin,ComputerNumber))&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#create db_info table</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;Create_db_info.sql&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="c">#verify initial entry</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from db_info&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="c">#print type(r)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">NoneType</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;insert into db_info values(&#39;taxdata&#39;,&#39;0.7&#39;,&#39;2012-04-30 16:24:00.000&#39;,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span>

        <span class="c">#create table indexes where needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE INDEX if not exists &#39;billDataCN&#39; ON &#39;billData&#39; (&#39;ComputerNumber&#39; ASC, &#39;TaxYear&#39; ASC)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE INDEX if not exists &#39;billDataName&#39; ON &#39;billData&#39; (&#39;LastName&#39; ASC, &#39;FirstName&#39; ASC, &#39;TaxYear&#39; ASC)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE INDEX if not exists &#39;taxPaymentsCN&#39; ON &#39;billData&#39; (&#39;ComputerNumber&#39; ASC, &#39;TaxYear&#39; ASC)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE INDEX if not exists &#39;taxPaymentsCN&#39; ON &#39;billData&#39; (&#39;PIN&#39; ASC, &#39;TaxYear&#39; ASC)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>        
        
    <span class="c">#####################################</span>
    <span class="c">#   GET AND SET VALUES FOR HP DATA  #</span>
    <span class="c">#####################################   </span>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getTaxData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getTaxData">[docs]</a>    <span class="k">def</span> <span class="nf">getTaxData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">foldername</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load data from the levy file for the year and return as a dict</span>
<span class="sd">        foldername is the name of the folder (i.e. 2009)</span>
<span class="sd">        filename is the the file TxxLEVY.TXT where xx is the 2 digit year</span>
<span class="sd">        header is the header list of fields</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#open the file based on foldername and filename</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">+</span><span class="s">&#39;BCO/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">taxdata</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">getfields</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">34</span><span class="p">):</span>
            <span class="n">getfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">tempdata</span> <span class="o">=</span><span class="p">[]</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span> <span class="c">#split the input on each tab</span>
            <span class="c">#iterate through get fields to create the value dictionary</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">getfields</span><span class="p">:</span>
                <span class="c">#append a tuple ofthe header and associated value that is</span>
                <span class="c">#indexed as i to the tempdata list</span>
                <span class="n">tfield</span> <span class="o">=</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">tempdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfield</span><span class="p">)</span>
            <span class="c">#create a dictionary with each municipality/uta as a key and tempdata as the value</span>
            <span class="n">taxdata</span><span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span> <span class="o">=</span><span class="n">tempdata</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;read tax data for </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">foldername</span>
        <span class="k">return</span> <span class="n">taxdata</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.setTaxData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setTaxData">[docs]</a>    <span class="k">def</span> <span class="nf">setTaxData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taxdata</span><span class="p">,</span><span class="n">taxyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        using the taxdata insert into tables.</span>
<span class="sd">        return none for good import or error message for errors</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c">#delete existing data for taxyear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from MuniTaxData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">taxyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from utaTaxData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">taxyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from tidTaxData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">taxyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c">#insert into muni data</span>
        <span class="n">err</span><span class="o">=</span><span class="s">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c">#iterate through the values in the taxdata dictionary</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">taxdata</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span><span class="s">&#39;&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from MuniTaxData where muninum=&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">taxyear</span><span class="p">))</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">z</span><span class="p">:</span>
                        <span class="n">getfields</span> <span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
                        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;insert into MuniTaxData values(&#39;</span><span class="si">%s</span><span class="s">&#39;,&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">getfields</span><span class="p">:</span>
                            <span class="n">ssql</span><span class="o">=</span><span class="n">ssql</span><span class="o">+</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c">#update the agratio from the agrats.txt file</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">+</span><span class="s">&quot;agrats.txt&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">agyear</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">taxyear</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">agyear</span> <span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">agmuni</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">agyear</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">agmuni</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">agratio</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="n">agmuni</span><span class="p">)</span>
                                <span class="n">agratio</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">agratio</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">agratio</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">agratio</span><span class="p">:</span>
                            <span class="n">agrato</span> <span class="o">=</span><span class="s">&#39;0.0&#39;</span>                                
                            
                        <span class="n">ssql</span><span class="o">=</span> <span class="n">ssql</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">,&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">agratio</span><span class="p">,</span><span class="n">taxyear</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">print</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c">#add uta and tid data</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">taxdata</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">ssql</span><span class="o">=</span> <span class="s">&quot;insert into utaTaxData values (&quot;</span>
                    <span class="n">getfields</span> <span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">getfields</span><span class="p">:</span>
                        <span class="n">ssql</span><span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;,&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">getfields</span> <span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">getfields</span><span class="p">:</span>
                        <span class="n">ssql</span><span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="s">&quot;,&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span><span class="o">%</span><span class="n">taxyear</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ssql</span><span class="o">=</span> <span class="s">&quot;insert into tidTaxData values (&quot;</span>
                    <span class="n">getfields</span> <span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">22</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">getfields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span><span class="s">&#39;OTHER&#39;</span><span class="p">:</span>
                            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">22</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> - TID&#39;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">elif</span>  <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;TID&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">22</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">22</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">ssql</span><span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;,&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">getfields</span> <span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ssql</span><span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">,&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">taxyear</span><span class="p">)</span>                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">print</span> <span class="n">v</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">e</span>        
        <span class="k">return</span> <span class="n">err</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getsetLegal"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getsetLegal">[docs]</a>    <span class="k">def</span> <span class="nf">getsetLegal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">foldername</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        insert data to the legal table and set by comp number from the HP text</span>
<span class="sd">        extract. return number of records inserted.</span>
<span class="sd">        foldername is the name of the folder (i.e. 2009)</span>
<span class="sd">        filename is the the file TxxLEGL1.TXT where xx is the 2 digit year</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#open file based on folder and filename</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">+</span><span class="s">&#39;BCO/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c">#clean the legal table for the tax year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from legal where taxyear =&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">foldername</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ldict</span> <span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">compnum</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">removeNulls</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
            <span class="c">#build the ldict with the compunter number as the key and the</span>
            <span class="c">#data of the list second index as the value</span>
            <span class="k">if</span> <span class="n">ldict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">compnum</span><span class="p">):</span>                         
                <span class="n">ldict</span><span class="p">[</span><span class="n">compnum</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ldict</span><span class="p">[</span><span class="n">compnum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
        <span class="c">#for all values in each key sort them then create a string from the list</span>
        <span class="c">#then use the new string as the value</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ldict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>               
            <span class="n">ldict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">legal</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">legal</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">legal</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ldict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">legal</span>  
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#need compnum to pin conversion dict so we can add pin numbers to the legal</span>
        <span class="n">pins</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;select pin,computernumber from billdata where taxyear = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">foldername</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldict</span><span class="p">)</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">pins</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ldict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>  <span class="o">+</span> <span class="mi">1</span>
            <span class="n">compnum</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">legal</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">pins</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">compnum</span><span class="p">):</span>
                <span class="n">compnum</span> <span class="o">=</span><span class="n">pins</span><span class="p">[</span><span class="n">compnum</span><span class="p">]</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update billData set legal=&quot;</span><span class="si">%s</span><span class="s">&quot; where pin=&quot;</span><span class="si">%s</span><span class="s">&quot; and TaxYear=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">legal</span><span class="p">,</span><span class="n">compnum</span><span class="p">,</span><span class="n">foldername</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;no pin with </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">compnum</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update billData set legal=&quot;</span><span class="si">%s</span><span class="s">&quot; where computernumber=&quot;</span><span class="si">%s</span><span class="s">&quot; and TaxYear=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">legal</span><span class="p">,</span><span class="n">compnum</span><span class="p">,</span><span class="n">foldername</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>        
        <span class="k">return</span> <span class="n">x</span>            
        </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getBillData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getBillData">[docs]</a>    <span class="k">def</span> <span class="nf">getBillData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">foldername</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load data from the tax master file for the year and return as a dict</span>
<span class="sd">        foldername is the name of the folder (i.e. 2009)</span>
<span class="sd">        filename is the the file TxxMAST.TXT where xx is the 2 digit year</span>
<span class="sd">        header is the header list of fields</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#open the file based on the foldername and filename</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">+</span><span class="s">&#39;BCO/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="c">#the next line opens the file where print conrtorl 1 and 3 items are</span>
        <span class="c">#written </span>
        <span class="n">pcf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">+</span><span class="s">&#39;printcontrol.txt&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">taxdata</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">billdata</span> <span class="o">=</span><span class="p">{}</span>
        <span class="n">getfields</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span>
                     <span class="mi">31</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
        <span class="c">#get field last value of 16 is the history which contains the document numbers for a property from the text extract from the HP</span>
        <span class="n">x</span> <span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">tempdata</span> <span class="o">=</span><span class="p">[]</span>
            <span class="n">templ</span> <span class="o">=</span> <span class="n">l</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">getfields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span><span class="s">&#39;x&#39;</span><span class="p">:</span>
                        <span class="n">tfield</span> <span class="o">=</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">tempdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfield</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tempdata</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
                <span class="n">billdata</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span><span class="n">tempdata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pcf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">templ</span><span class="p">)</span> <span class="c">#write data tothe pcf file if it is print conrtrol 1 or 3</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pcf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;read bill data for </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">foldername</span>
        <span class="k">return</span> <span class="n">billdata</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.setBillData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setBillData">[docs]</a>    <span class="k">def</span> <span class="nf">setBillData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">billdata</span><span class="p">,</span><span class="n">taxyear</span><span class="p">):</span>
         <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         using the billdata insert into tables. return none for good import or</span>
<span class="sd">         error message for errors</span>

<span class="sd">         &quot;&quot;&quot;</span>
         <span class="c">#delete taxyear data</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from billData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">taxyear</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
         <span class="k">print</span> <span class="s">&#39;Start setting Bill Data for </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">taxyear</span>
         <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="c">#iterate through the values in the billdata dictionary and format them as necessary</span>
         <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">billdata</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
             <span class="n">z</span> <span class="o">=</span><span class="s">&#39;&#39;</span>
             <span class="n">x</span> <span class="o">=</span>  <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
             <span class="c">#create the sql statement</span>
             <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;insert into BillData values(&quot;</span>                 
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">):</span>                 
                 <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
                     <span class="c">#remove single quotes replace with accent mark</span>
                     <span class="n">tstr</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span><span class="s">&quot;`&quot;</span><span class="p">)</span>
                     <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;,&quot;</span><span class="o">%</span><span class="n">tstr</span>
                 <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span><span class="mi">21</span><span class="p">:</span>
                     <span class="c">#change value to an integer</span>
                     <span class="n">tstr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>                        
                     <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,&quot;</span><span class="o">%</span><span class="n">tstr</span>
                 <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span><span class="mi">20</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span><span class="mi">33</span> <span class="p">:</span>
                     <span class="c">#create a floating vlaue</span>
                     <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
                     <span class="n">tstr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
                     <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,&quot;</span><span class="o">%</span><span class="n">tstr</span>
                 <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span><span class="mi">50</span><span class="p">:</span>
                     <span class="c">#add a 0 value field</span>
                     <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">+</span><span class="s">&quot;0,&quot;</span>
                 <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span><span class="mi">15</span><span class="p">:</span>
                     <span class="c">#calculate acres</span>
                     <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
                     <span class="n">tstr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
                     <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,&quot;</span><span class="o">%</span><span class="n">tstr</span>                                   
                 <span class="k">else</span><span class="p">:</span>
                     <span class="c">#there is an error print the issue</span>
                     <span class="k">print</span> <span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;?&#39;</span>
             <span class="c">#create the deeded name</span>
             <span class="n">deededname</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
             <span class="n">deededname</span> <span class="o">=</span> <span class="n">deededname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
             <span class="c">#create a string that contains all document numbers in an acceptable format</span>
             <span class="n">document</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">33</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
             <span class="n">document</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
             <span class="n">document</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
             <span class="c">#fix string issues</span>
             <span class="n">document</span> <span class="o">=</span> <span class="n">removeNulls</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
             <span class="n">document</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
             <span class="c">#ccomplete the sql statement then try to execute it</span>
             <span class="n">ssql</span><span class="o">=</span> <span class="n">ssql</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;&#39;&#39;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;NA&quot;,&quot;P&quot;,0,0,0,0,&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">document</span><span class="p">,</span><span class="n">deededname</span><span class="p">,</span><span class="n">taxyear</span><span class="p">)</span>
             <span class="k">try</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
             <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                 <span class="k">print</span> <span class="n">e</span>
                 <span class="k">print</span> <span class="n">ssql</span>                 
             <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>                
         <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.fixHPDuplicatePins"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.fixHPDuplicatePins">[docs]</a>    <span class="k">def</span> <span class="nf">fixHPDuplicatePins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find and correct duplicate pins in the HP data for each tax year from 2003 through 2009.</span>
<span class="sd">        add the pins to the duplicatePIN table for fixing payment data</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#clear the duplicatePin table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from duplicatePin&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c">#start at lowest year (2003) and fix up to 2009</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span><span class="mi">2010</span><span class="p">):</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;  select  PIN</span>
<span class="s">                                ,count(PIN)</span>
<span class="s">                        from billData</span>
<span class="s">                        where TaxYear = &#39;</span><span class="si">%s</span><span class="s">&#39;</span>
<span class="s">                        group by PIN,TaxYear</span>
<span class="s">                        having count(PIN)&gt;1</span>
<span class="s">                        order by count(PIN) desc&quot;&quot;&quot;</span><span class="o">%</span><span class="n">year</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            
            <span class="c">#for each record find all pin/computer number combos, create a new pin, add to duplicatePin table</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="c">#find computernumbers that match PIN</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select ComputerNumber,count(ComputerNumber) from billData where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; group by computernumber&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="c">#set PIN number base</span>
                <span class="n">newpin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="s">&#39;1&#39;</span>
                <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="c">#for the pin computernumber combo create new pin change in billdata for all years and add new pin to dupicate pin number</span>
                <span class="k">for</span> <span class="n">compnum</span> <span class="ow">in</span> <span class="n">cn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;insert into duplicatePin values(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">compnum</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">newpin</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;update billData set pin=&#39;</span><span class="si">%s</span><span class="s">&#39; where pin=&#39;</span><span class="si">%s</span><span class="s">&#39; and computernumber=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">newpin</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">compnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">newpin</span> <span class="o">=</span> <span class="n">newpin</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newpin</span> <span class="o">=</span> <span class="n">newpin</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;year </span><span class="si">%s</span><span class="s"> had </span><span class="si">%s</span><span class="s"> duplicate pins&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">))</span>
                  
    <span class="c">#####################################</span>
    <span class="c">#   GET AND SET VALUES FOR ACS DATA #</span>
    <span class="c">#####################################</span></div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getTaxdata"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getTaxdata">[docs]</a>    <span class="k">def</span> <span class="nf">getTaxdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollyear</span><span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the tax data from ACS. rollyear is the four digit year. return</span>
<span class="sd">        sqlite3 object</span>
<span class="sd">        NOTE: this function is for ACS and is named very similarly to the</span>
<span class="sd">        getTaxData HP function (it should be renamed!!!)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;ACS_getTaxdata.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%taxyear%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rollyear</span><span class="p">))</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span>
    </div>
    <span class="nd">@timed</span>    
<div class="viewcode-block" id="Taxdata.setTaxdata"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setTaxdata">[docs]</a>    <span class="k">def</span> <span class="nf">setTaxdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        insert ACS data into taxdata. r is a tuple of tuple taxdata from</span>
<span class="sd">        getTaxdata. rollyear is the four digit year. return number</span>
<span class="sd">        of records added</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#start with a clean table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from taxdata where rollyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>               
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>            
                <span class="n">s</span> <span class="o">=</span><span class="s">&#39;&#39;&#39;</span><span class="si">%s</span><span class="s">,&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">removeNulls</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c">#from utilites module</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">rollyear</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c">#from utilites module</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;insert into taxdata values(</span><span class="si">%s</span><span class="s">)&quot;</span><span class="o">%</span><span class="n">s</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">e</span>
                <span class="k">print</span> <span class="n">ssql</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getMuniSchoolTaxData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getMuniSchoolTaxData">[docs]</a>    <span class="k">def</span> <span class="nf">getMuniSchoolTaxData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get municipality tax data for schools and mills, etc... rollyear is</span>
<span class="sd">        the four digit year.  return three dictionaries: municipality, uta and tid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#get all tax data from acs</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;ACS_MillRatesAndUTA.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%taxyear%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rollyear</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>        
        <span class="c">#create temp dicts</span>
        <span class="n">munidict</span> <span class="o">=</span><span class="p">{}</span>
        <span class="n">utadict</span> <span class="o">=</span><span class="p">{}</span>
        <span class="n">tiddict</span> <span class="o">=</span><span class="p">{}</span>
        <span class="c">#populate temp dicts with base data dicts for table type</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">muninum</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span>
                <span class="n">munidict</span><span class="p">[</span><span class="n">muninum</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;MuniNum&#39;</span><span class="p">:</span><span class="n">muninum</span><span class="p">,</span><span class="s">&#39;StateMill&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;StateAid&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;CountyMill&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;CountyAid&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;LocalMill&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;LocalAid&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
                                     <span class="s">&#39;CVTCMill&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;CVTCAid&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;AgRatio&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="s">&#39;TaxYear&#39;</span><span class="p">:</span><span class="n">rollyear</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">muninum</span> <span class="o">!=</span> <span class="s">&#39;0100&#39;</span> <span class="ow">and</span> <span class="n">muninum</span> <span class="o">!=</span> <span class="s">&#39;STATE&#39;</span> <span class="ow">and</span> <span class="n">muninum</span> <span class="o">!=</span> <span class="s">&#39;COUNTY&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">utadict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;uta&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;MuniNum&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="s">&#39;utaName&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="s">&#39;utaMill&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;utaAid&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
                                  <span class="s">&#39;LotteryCreditMill&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s">&#39;SchoolCreditRate&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s">&#39;TaxYear&#39;</span><span class="p">:</span><span class="n">rollyear</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uta</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">tiddict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span><span class="p">{</span><span class="s">&#39;tid&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;tidName&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;uta&#39;</span><span class="p">:</span><span class="n">uta</span><span class="p">,</span><span class="s">&#39;utaMill&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;MuniNum&#39;</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="s">&#39;TaxYear&#39;</span><span class="p">:</span><span class="n">rollyear</span><span class="p">}</span>      
        <span class="c">#update the muni table data</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span><span class="s">&#39;0100&#39;</span><span class="p">:</span>
                <span class="n">munidict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="s">&#39;CVTCMill&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">munidict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="s">&#39;CVTCAid&#39;</span><span class="p">]</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>                
            <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;STATE&#39;</span><span class="p">:</span>
                <span class="n">munidict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="s">&#39;StateMill&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">munidict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="s">&#39;StateAid&#39;</span><span class="p">]</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>                
            <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;COUNTY&#39;</span><span class="p">:</span>
                <span class="n">munidict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="s">&#39;CountyMill&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">munidict</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="s">&#39;CountyAid&#39;</span><span class="p">]</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">munidict</span><span class="p">,</span><span class="n">utadict</span><span class="p">,</span><span class="n">tiddict</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.setMuniSchoolTaxData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setMuniSchoolTaxData">[docs]</a>    <span class="k">def</span> <span class="nf">setMuniSchoolTaxData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">muni</span><span class="p">,</span><span class="n">uta</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        insert shcoool, muni millrates and associated data into the appropriate</span>
<span class="sd">        tables. the following variable are required</span>
<span class="sd">        * muni = the muni dictionary returnedfrom getMuniSchoolTaxData</span>
<span class="sd">        * uta = uta dictionary returned from getMuniSchoolTaxData</span>
<span class="sd">        * tid = tid dictionary returned from getMuniSchoolTaxData</span>
<span class="sd">        * rollyear = the four digit year</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#remove roll year tax data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from MuniTaxData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from utaTaxData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;delete from tidTaxData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
        
        <span class="c">#set muniTaxData </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">muni</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>            
            <span class="n">sets</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>            
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span><span class="s">&#39;MuniNum&#39;</span><span class="p">:</span>
                    
                    <span class="n">sets</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sets</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;insert into muniTaxData (</span><span class="si">%s</span><span class="s">) values(</span><span class="si">%s</span><span class="s">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">vals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="c">#set uta </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uta</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">sets</span> <span class="o">=</span><span class="s">&#39;&#39;</span>
            <span class="n">vals</span><span class="o">=</span><span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span><span class="s">&#39;MuniNum&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span><span class="s">&#39;uta&#39;</span> <span class="ow">or</span> <span class="n">k</span><span class="o">==</span><span class="s">&#39;utaName&#39;</span><span class="p">:</span>                    
                    <span class="n">sets</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sets</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;insert into utaTaxData (</span><span class="si">%s</span><span class="s">) values(</span><span class="si">%s</span><span class="s">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">vals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="c">#set tid </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tid</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">sets</span> <span class="o">=</span><span class="s">&#39;&#39;</span>
            <span class="n">vals</span><span class="o">=</span><span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span><span class="s">&#39;utaMill&#39;</span><span class="p">:</span>
                    <span class="n">sets</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sets</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;insert into tidTaxData (</span><span class="si">%s</span><span class="s">) values(</span><span class="si">%s</span><span class="s">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span><span class="n">vals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        </div>
    <span class="nd">@timed</span> 
<div class="viewcode-block" id="Taxdata.setACSBillData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setACSBillData">[docs]</a>    <span class="k">def</span> <span class="nf">setACSBillData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        insert ACS data insert it into the billData table. r is a tuple of tuple</span>
<span class="sd">        taxdata from getTaxdatarollyear is the four digit year. return number</span>
<span class="sd">        of records added</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c">#start with a clean table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from billdata where taxyear=</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>            
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">42</span><span class="p">]</span> <span class="o">&gt;</span><span class="n">i</span><span class="p">[</span><span class="mi">42</span><span class="p">]:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">42</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>       
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">getFields</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;insert into billData values(</span><span class="si">%s</span><span class="s">)&quot;</span><span class="o">%</span><span class="n">s</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>  <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
</div>
    <span class="nd">@timed</span>                           
<div class="viewcode-block" id="Taxdata.updateACSBillData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.updateACSBillData">[docs]</a>    <span class="k">def</span> <span class="nf">updateACSBillData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update ACS bill Data with data from the newProperty table in the</span>
<span class="sd">        property.sqlite database.  rollyear is the four digit year. return</span>
<span class="sd">        number of records added</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#get data fromthe billdata table in the taxdata.sqlite database</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select PIN,taxyear from billData where TaxYear= &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">rollyear</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>  <span class="o">+</span> <span class="mi">1</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c">#get data from the property.sqlite database</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select DocumentNumber, History, Legal from newProperty where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and RollYear =&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>        <span class="c">#pc is the cursor for the property database</span>
            <span class="c">#if there are records then process the data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">document</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">document</span><span class="p">,</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">document</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">document</span> <span class="o">=</span><span class="s">&#39;NA&#39;</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">document</span><span class="p">)</span> <span class="c">#from utilites module</span>
                
                <span class="n">legal</span> <span class="o">=</span> <span class="n">removeNulls</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="c">#from utilites module</span>
                <span class="n">legal</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">legal</span><span class="p">)</span> <span class="c">#from utilites module</span>
                <span class="n">legal</span> <span class="o">=</span> <span class="n">legal</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
                <span class="c">#if legal is not present or contains garbage set to NA</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">legal</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">legal</span> <span class="o">=</span> <span class="s">&#39;NA&#39;</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update billData set Documents= &quot;</span><span class="si">%s</span><span class="s">&quot;, legal=&quot;</span><span class="si">%s</span><span class="s">&quot; where PIN=&quot;</span><span class="si">%s</span><span class="s">&quot; and TaxYear =&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">document</span><span class="p">,</span><span class="n">legal</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update billData set Documents= &quot;na&quot;, legal=&quot;na&quot; where PIN=&quot;</span><span class="si">%s</span><span class="s">&quot; and TaxYear =&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
            
                </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getRealTaxValues"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getRealTaxValues">[docs]</a>    <span class="k">def</span> <span class="nf">getRealTaxValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the real values for properties from ACS for the taxdata table.</span>
<span class="sd">        this will include the land class, acres, and types of values.</span>
<span class="sd">        the info will be inserted into the billData table by pin and rollyear.</span>
<span class="sd">        rollyear is the four digit year. return an sqlite object (tuple of</span>
<span class="sd">        tuples)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;ACS_getRealTaxValues.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%taxyear%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rollyear</span><span class="p">))</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.setRealTaxValues"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setRealTaxValues">[docs]</a>    <span class="k">def</span> <span class="nf">setRealTaxValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the real property values for a property with data from getREalTaxValues</span>
<span class="sd">        r is the sqlite object (a tuple tuples that are tax values). rollyear</span>
<span class="sd">        is the four digit year. return the number of records added</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#start with a clean table for the rollyear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from taxValues where taxyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#insert the data per record in r</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>              
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;insert into taxValues values(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">e</span>
                
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>            
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
</div>
<div class="viewcode-block" id="Taxdata.getRealTaxes"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getRealTaxes">[docs]</a>    <span class="k">def</span> <span class="nf">getRealTaxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the real property taxes on tax bills for a tax year. rollyear is</span>
<span class="sd">        the four digit year. return an sqlite3 object (tuple of tuples)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;ACS_getRealTaxes.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%taxyear%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rollyear</span><span class="p">))</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.setRealTaxes"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setRealTaxes">[docs]</a>    <span class="k">def</span> <span class="nf">setRealTaxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        use the imported data from ACS in the taxValues table to calculate the</span>
<span class="sd">        taxes and set them in the correct bill for a rollyear. r is the results</span>
<span class="sd">        from the getRealTaxes (sqlite object... a tuple of tuples). rollyear is</span>
<span class="sd">        the four digit year.  return the number of records added</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>  <span class="o">+</span> <span class="mi">1</span>
            <span class="c">#determine where to add the amount in the billdata table</span>
            <span class="n">taxtype</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span>
                <span class="n">taxdue</span> <span class="o">=</span>  <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">taxdue</span><span class="o">=</span><span class="mi">0</span> 
            <span class="n">s</span><span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">taxtype</span> <span class="o">==</span> <span class="s">&#39;FDC&#39;</span> <span class="ow">or</span> <span class="n">taxtype</span> <span class="o">==</span> <span class="s">&#39;LOT&#39;</span><span class="p">:</span>
                <span class="c">#this is a lottery credit or first dollar credit</span>
                <span class="k">if</span> <span class="n">taxtype</span> <span class="o">==</span><span class="s">&#39;FDC&#39;</span><span class="p">:</span>
                    <span class="c">#first dollar</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;FirstDollarAmount&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">#lottery Credit</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;LotteryCreditAmount&#39;</span>                  
                
            <span class="k">elif</span> <span class="n">taxtype</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;F&#39;</span><span class="p">:</span>
                <span class="c">#this is forest crop or mfl</span>
                <span class="c">#determine which it is </span>
                <span class="k">if</span> <span class="n">taxtype</span> <span class="o">==</span> <span class="s">&#39;FL-W5&#39;</span> <span class="ow">or</span> <span class="n">taxtype</span> <span class="o">==</span> <span class="s">&#39;FL-W7&#39;</span><span class="p">:</span>
                    <span class="c">#open mfl</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;MFLOpen&#39;</span>
                <span class="k">elif</span> <span class="n">taxtype</span> <span class="o">==</span> <span class="s">&#39;FL-W6&#39;</span> <span class="ow">or</span> <span class="n">taxtype</span> <span class="o">==</span> <span class="s">&#39;FL-W8&#39;</span><span class="p">:</span>
                    <span class="c">#closed mfl</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;MFLClosed&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">#forest crop</span>
                    <span class="n">s</span><span class="o">=</span><span class="s">&#39;ForestCrop&#39;</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxtype</span><span class="p">)</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="c">#this is a SA, SC or DU</span>
                <span class="n">taxtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">taxtype</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">taxtype</span> <span class="o">&lt;</span><span class="mi">11</span><span class="p">:</span>
                    <span class="c">#SA</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;SpecialAssessment&#39;</span>
                <span class="k">elif</span> <span class="n">taxtype</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">:</span>
                    <span class="c">#DU</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;DelinquentUtilities&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;SpecialCharge&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#is is a real property tax</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;RealTaxGross&#39;</span>
                
            <span class="c">#get record data </span>
            <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select PIN,TaxYear,RealTaxGross as rtg,</span><span class="si">%s</span><span class="s"> from billData where PIN =&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear = </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="c">#calculate amounts for total gross tax portion tax </span>
            <span class="n">totaltaxdue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bill</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">taxdue</span>
            <span class="n">portiontaxdue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bill</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="n">taxdue</span>
            <span class="c">#update record</span>
            <span class="n">ssql</span> <span class="o">=</span><span class="s">&quot;update billData set RealTaxGross = </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s"> where PIN =&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear = </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">totaltaxdue</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">portiontaxdue</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>                
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.setRealTaxesNet"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setRealTaxesNet">[docs]</a>    <span class="k">def</span> <span class="nf">setRealTaxesNet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update the net taxes on all records for a roll year. rollyear is the</span>
<span class="sd">        four digit year. return the number of records updated</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select PIN, RealTaxGross, SpecialAssessment,DelinquentUtilities,SpecialCharge,MFLOpen,MFLClosed,</span>
<span class="s">FirstDollarAmount,LotteryCreditAmount,LotteryCreditUsed from billData where TaxYear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>         
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">lc</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nettax</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">-</span> <span class="n">lc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;update billData Set RealTaxNet = </span><span class="si">%s</span><span class="s">, LotteryCreditUsed = </span><span class="si">%s</span><span class="s"> where PIN =&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear = </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nettax</span><span class="p">,</span><span class="n">lc</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">rollyear</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getPayemnts"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getPayemnts">[docs]</a>    <span class="k">def</span> <span class="nf">getPayemnts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get all payments for rollyear from ACS. rollyear is the four digit</span>
<span class="sd">        year. return an sqlite3 object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#if no rollyear set to current year</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;ACS_getPayments.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%taxyear%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rollyear</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.setPayments"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.setPayments">[docs]</a>    <span class="k">def</span> <span class="nf">setPayments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the payements for all records in a data set for a rollyear.  </span>
<span class="sd">        rollyear is the four digit year. r is the data set from getPayments</span>
<span class="sd">        (sqlite3 objet... a tuple of tuples). return the number of records that</span>
<span class="sd">        have been inserted</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from taxPayments where taxyear =</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#create duplicate pin dictionary to correct issues with duplicate pins</span>
        <span class="c">#that existed in the HP</span>
        <span class="n">pindup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tpins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select * from duplicatepin&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tpins</span><span class="p">:</span>
            <span class="n">pindup</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">y</span> <span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>        
                <span class="n">i</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">removeNulls</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
                <span class="n">i</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixUnicode</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c">#fix duplicate pin to new pin             </span>
            <span class="k">if</span> <span class="n">rollyear</span> <span class="o">&lt;</span> <span class="mi">2010</span> <span class="ow">and</span> <span class="n">pindup</span><span class="o">.</span><span class="n">has_key</span><span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pindup</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>               
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;insert into taxPayments values(&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                                                                                                                   <span class="n">i</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;not unique&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; &#39;</span>
                    <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;insert into taxPayments values(&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                                                                                                           <span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>                    
                <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;syntax error&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">i</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;insert into taxPayments values(&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;,</span><span class="si">%s</span><span class="s">)&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                                                                                                           <span class="n">i</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>            
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getsetBillPayment"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getsetBillPayment">[docs]</a>    <span class="k">def</span> <span class="nf">getsetBillPayment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set total payments made on a property. rollyear is the foru digit year</span>
<span class="sd">        return the number of payements updated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;select sum(amount),pin,taxyear from taxpayments where taxyear=</span><span class="si">%s</span><span class="s"> group by pin&quot;</span><span class="o">%</span><span class="n">rollyear</span> <span class="c">#use sum to add all payment together as this is all we care about</span>
        <span class="n">payments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">payment</span> <span class="ow">in</span> <span class="n">payments</span><span class="p">:</span>
            <span class="n">ssql</span> <span class="o">=</span><span class="s">&quot;update billData set Payment=</span><span class="si">%s</span><span class="s"> where pin=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">payment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">payment</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rollyear</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>  <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">payments</span><span class="p">)</span>           
        </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getsetTaxPayments"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getsetTaxPayments">[docs]</a>    <span class="k">def</span> <span class="nf">getsetTaxPayments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets all payments for a rollyear then sets them to the pin and tax year</span>
<span class="sd">        this is needed for calculation penalty and interest. use the computer</span>
<span class="sd">        number if tax year is less than 2010 due to pin conflicts. return the</span>
<span class="sd">        number of records updated</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#if no roll year set to current year</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>            
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;getTaxPayments.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%taxyear%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rollyear</span><span class="p">))</span>
        <span class="c">#replace pin to alt number if year is less than 2010 due to issues with HP data</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">&lt;</span> <span class="mi">2010</span><span class="p">:</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;b_parcel_id&#39;</span><span class="p">,</span><span class="s">&#39;b_alt_pin&#39;</span><span class="p">)</span>
        <span class="n">payments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> total payements for tax year </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payments</span><span class="p">),</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">payment</span> <span class="ow">in</span> <span class="n">payments</span><span class="p">:</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update BillData set TaxPayment = </span><span class="si">%s</span><span class="s"> where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">payment</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">payment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">payment</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">rollyear</span> <span class="o">&lt;</span> <span class="mi">2010</span><span class="p">:</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update BillData set TaxPayment = </span><span class="si">%s</span><span class="s"> where ComputerNumber=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">payment</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">payment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">payment</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">print</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">payments</span><span class="p">)</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getsetVoids"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getsetVoids">[docs]</a>    <span class="k">def</span> <span class="nf">getsetVoids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets all voided payments and applies to the tax payments. rollyear is</span>
<span class="sd">        the four digit year. return number of records updated</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlpath</span><span class="o">+</span><span class="s">&quot;getVoids.sql&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%taxyear%&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rollyear</span><span class="p">))</span>
        <span class="c">#replace pin to alt number if year is less than 2010 due to issues with HP data</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">&lt;</span> <span class="mi">2010</span><span class="p">:</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="n">ssql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;b_parcel_id&#39;</span><span class="p">,</span><span class="s">&#39;b_alt_pin&#39;</span><span class="p">)</span>
        <span class="n">voids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> voided payements for taxyear </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">voids</span><span class="p">),</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="c">#process all records and use the PIN for years greater than 2010</span>
        <span class="k">for</span> <span class="n">void</span> <span class="ow">in</span> <span class="n">voids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rollyear</span> <span class="o">&lt;</span> <span class="mi">2010</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select computernumber,TaxYear,TaxPayment from billData where computernumber=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">void</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">void</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="n">taxpaid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">void</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update BillData set TaxPayment = </span><span class="si">%s</span><span class="s"> where computernumber=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">taxpaid</span><span class="p">,</span><span class="n">void</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">void</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select PIN,TaxYear,TaxPayment from billData where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">void</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">void</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>                
                <span class="c">#record = self.lc.execute(&quot;&quot;&quot;select PIN,TaxYear,TaxPayment from billData where pin=&#39;%s&#39; and TaxYear=%s&quot;&quot;&quot;%(void[0],void[1])).fetchall()</span>
                <span class="n">taxpaid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">void</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update BillData set TaxPayment = </span><span class="si">%s</span><span class="s"> where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">taxpaid</span><span class="p">,</span><span class="n">void</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">void</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">voids</span><span class="p">)</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.getsetOverride"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getsetOverride">[docs]</a>    <span class="k">def</span> <span class="nf">getsetOverride</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get all properties with override penalty and interest from acs and add</span>
<span class="sd">        to bill data for calculate penalty and interest. return the number of</span>
<span class="sd">        updated records</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select b_parcel_id,b_tax_year,b_int_rate_override,b_pen_rate_override from lr_bill_attributes where b_override_flag  = &#39;T&#39;&quot;&quot;&quot;</span>
        <span class="n">override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
        <span class="c">#if no override exists set it to 0.0 to be ignored</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">override</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">penrate</span> <span class="o">=</span> <span class="mf">0.00</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">penrate</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">intrate</span> <span class="o">=</span> <span class="mf">0.00</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intrate</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;update billData set OverrideInt =</span><span class="si">%s</span><span class="s">, OverridePen=</span><span class="si">%s</span><span class="s"> where pin=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">intrate</span><span class="p">,</span><span class="n">penrate</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c">#print ssql</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
    <span class="c">#######################################################</span>
    <span class="c">#   CALLS TO BUILD DATA FOR HP AND ACS TAXYEARS       #</span>
    <span class="c">#######################################################</span></div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.buildMuniNameTable"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.buildMuniNameTable">[docs]</a>    <span class="k">def</span> <span class="nf">buildMuniNameTable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        populate the municipality table with data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muniname</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;delete from MuniName&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from ao_l_pin_municipality&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;insert into MuniName values(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muniname</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.updateBillData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.updateBillData">[docs]</a>    <span class="k">def</span> <span class="nf">updateBillData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taxyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update fields not set by the setBillData function : muni info, school name, mill rates, state aid, agratio....</span>
<span class="sd">        based on four digit taxyear. return number of updated records</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&#39;Update data for </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">taxyear</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select PIN,TaxYear,uta from billData where TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="n">taxyear</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">muninum</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">uta</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c">#get muni info and main mill rates</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select * from MuniTaxData where muninum=&#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">muninum</span><span class="p">,</span><span class="n">taxyear</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">muniname</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">muninum</span><span class="p">):</span>
                <span class="n">muniname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muniname</span><span class="p">[</span><span class="n">muninum</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">muniname</span> <span class="o">=</span> <span class="s">&#39;None&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;update billData set muniNumber=&#39;</span><span class="si">%s</span><span class="s">&#39;,MuniName=&#39;</span><span class="si">%s</span><span class="s">&#39;, stateMillRate=</span><span class="si">%s</span><span class="s">,stateAid=</span><span class="si">%s</span><span class="s">,countyMillRate=</span><span class="si">%s</span><span class="s">,countyAid=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">localMillRate=</span><span class="si">%s</span><span class="s">, localAid=</span><span class="si">%s</span><span class="s">, cvtcmillrate=</span><span class="si">%s</span><span class="s">, cvtcaid=</span><span class="si">%s</span><span class="s">,  AgRatio=</span><span class="si">%s</span><span class="s"> where PIN = &#39;</span><span class="si">%s</span><span class="s">&#39; and TaxYear = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">muninum</span><span class="p">,</span><span class="n">muniname</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                                                                                                                <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">],</span>
                                                                                                                <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span><span class="n">pin</span><span class="p">,</span><span class="n">taxyear</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">e</span>
                <span class="k">print</span> <span class="n">x</span>
                <span class="k">print</span> <span class="n">r</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>         
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="c">#set school data and tid data</span>
            <span class="c">#check for TID, if TID get tid</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uta</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">tiddata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select * from tidTaxData where tid =&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">uta</span><span class="p">,</span><span class="n">taxyear</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update billData set tidName = &#39;</span><span class="si">%s</span><span class="s">&#39;, tidMillRate =</span><span class="si">%s</span><span class="s">, tidAid =</span><span class="si">%s</span><span class="s"> where pin=&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear =&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tiddata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">tiddata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                                                                                                                           <span class="n">tiddata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span><span class="n">pin</span><span class="p">,</span><span class="n">taxyear</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update billData set tidName = &#39;NA&#39; where pin=&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear =&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span><span class="n">taxyear</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="c">#update school data</span>
            <span class="n">uta</span> <span class="o">=</span> <span class="n">uta</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;Select utaName,utaMill,utaAid,LotteryCreditMill,SchoolCreditRate from utaTaxData where uta = &#39;</span><span class="si">%s</span><span class="s">&#39; and MuniNum = &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">uta</span><span class="p">,</span><span class="n">muninum</span><span class="p">)</span>
            <span class="n">utadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">utadata</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;update billData set schoolName=&#39;</span><span class="si">%s</span><span class="s">&#39;, schoolMillRate=</span><span class="si">%s</span><span class="s">, schoolAid=</span><span class="si">%s</span><span class="s">, LotteryCreditMill=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">SchoolCredit=</span><span class="si">%s</span><span class="s"> where pin=&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">utadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">utadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">utadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">utadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">utadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">pin</span><span class="p">,</span> <span class="n">taxyear</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> - has no uta&#39;</span><span class="o">%</span><span class="n">pin</span>        
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span></div>
<div class="viewcode-block" id="Taxdata.getInstallmentDates"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.getInstallmentDates">[docs]</a>    <span class="k">def</span> <span class="nf">getInstallmentDates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get installment dates and grace period. only applies to the current</span>
<span class="sd">        tax year for calculating status. rollyear is the four digit year. this</span>
<span class="sd">        sets the class atributes for first and seocnd installment</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;select * from bco_l_installment_config where tax_year =&#39;</span><span class="si">%s</span><span class="s">&#39; and Bill_type=&#39;RP&#39;&quot;</span><span class="o">%</span><span class="n">rollyear</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
            <span class="n">idate</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">iday</span> <span class="o">=</span> <span class="n">idate</span><span class="o">.</span><span class="n">day</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstInstallment</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="c">#set grace period</span>
                <span class="c">#if first installment is saturday or sunday move to monday</span>
                <span class="n">iday</span> <span class="o">=</span>  <span class="n">datetime</span><span class="o">.</span><span class="n">weekday</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstInstallment</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">iday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">dayplus</span> <span class="o">=</span> <span class="mi">7</span>
                <span class="k">if</span> <span class="n">iday</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">dayplus</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dayplus</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstInstallment</span><span class="p">[</span><span class="s">&#39;gracedate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstInstallment</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">dayplus</span><span class="p">)</span>          
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondInstallment</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="c">#set grace period</span>
                <span class="c">#if first installment is saturday or sunday move to monday</span>
                <span class="n">iday</span> <span class="o">=</span>  <span class="n">datetime</span><span class="o">.</span><span class="n">weekday</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondInstallment</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">iday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">dayplus</span> <span class="o">=</span> <span class="mi">7</span>
                <span class="k">if</span> <span class="n">iday</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">dayplus</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dayplus</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondInstallment</span><span class="p">[</span><span class="s">&#39;gracedate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondInstallment</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">dayplus</span><span class="p">)</span>
        </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.updatePaymentStatus"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.updatePaymentStatus">[docs]</a>    <span class="k">def</span> <span class="nf">updatePaymentStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update the status of bills that are other than paid. rollyear is the</span>
<span class="sd">        four digit year</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#get all records that are not paid in full</span>
        <span class="n">ssql</span><span class="o">=</span> <span class="s">&#39;&#39;&#39;select * from billData where Status != &quot;P&quot; and TaxYear =&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="n">rollyear</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="c">#why is this next line here? was it for testing.  it is commented out as of 06/29/2012</span>
        <span class="c">#return r</span>
        <span class="c">#</span>
        <span class="c">#</span>
        <span class="n">curyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">curdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getInstallmentDates</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="c">#loop through results and set status based on year and payments</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="c">#for current year only check the A and PP status vs. the date of the grace period</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">54</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">curyear</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                    <span class="c">#set to status to DLQ if status is A after grace period for 1st installment past for current taxyear </span>
                    <span class="k">if</span> <span class="n">curdate</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstInstallment</span><span class="p">[</span><span class="s">&#39;gracedate&#39;</span><span class="p">]:</span>
                        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update billData set status = &quot;DLQ&quot;  where pin=&quot;</span><span class="si">%s</span><span class="s">&quot; and rollyear= &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">54</span><span class="p">])</span>
                
                <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">==</span><span class="s">&#39;PP&#39;</span><span class="p">:</span>
                    <span class="c">#set to status to DLQ if status is PP after grace period for 2nd installment past for current taxyear </span>
                    <span class="k">if</span> <span class="n">curdate</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondInstallment</span><span class="p">[</span><span class="s">&#39;gracedate&#39;</span><span class="p">]:</span>
                        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update billData set status = &quot;DLQ&quot;  where pin=&quot;</span><span class="si">%s</span><span class="s">&quot; and rollyear= &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">54</span><span class="p">])</span>                    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span> <span class="ow">or</span> <span class="n">i</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;PP&#39;</span><span class="p">:</span>
                    <span class="n">ssql</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;update billData set status = &quot;DLQ&quot;  where pin=&quot;</span><span class="si">%s</span><span class="s">&quot; and rollyear= &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;&#39;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">54</span><span class="p">])</span>    
        <span class="k">return</span> <span class="n">r</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.buildHPData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.buildHPData">[docs]</a>    <span class="k">def</span> <span class="nf">buildHPData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        get data from HP text extract files. these files are located in the</span>
<span class="sd">        subdirectory ./files/BCO and further broken down by tax year. this</span>
<span class="sd">        method will use the getDataFolders function from the utilities module</span>
<span class="sd">        to get all folders and files that are in the ./file/BCO directory and</span>
<span class="sd">        build the tax base from those text extract files</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">getDataFolders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span><span class="c">#the location of the files is set here.  </span>
        <span class="c">#loop through the folders and get data (only taxdata not bills for now)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">levyheader</span> <span class="o">=</span> <span class="n">getHeader</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>     <span class="c">#creates the header which is used to search for taxdata. uses the utility function getHeader</span>
            <span class="c">#get the levy data from the HP files</span>
            <span class="n">taxdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTaxData</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">levyheader</span><span class="p">)</span> 
            <span class="c">#insert into tax data tables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setTaxData</span><span class="p">(</span><span class="n">taxdata</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="c">#get bill data info</span>
            <span class="n">billheader</span> <span class="o">=</span> <span class="n">getHeader</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>     <span class="c">#creates the header which is used to search for billdata. uses the utility function getHeader</span>
            <span class="c">#get the billdata from the HP file</span>
            <span class="n">billdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBillData</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">billheader</span><span class="p">)</span>
            <span class="c">#insert into billdata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setBillData</span><span class="p">(</span><span class="n">billdata</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="c">#populate thee municipality data table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buildMuniNameTable</span><span class="p">()</span>
            <span class="c">#updates the billdata table with additional info from the levy, tid, uta and muni tables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateBillData</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="c">#updates the legal of all percels in a file</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsetLegal</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c">#as there were duplicate pins in the HP the next line creates</span>
        <span class="c">#unique pin numbers for all duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixHPDuplicatePins</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;HP text import done&#39;</span>
            </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.buildACSData"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.buildACSData">[docs]</a>    <span class="k">def</span> <span class="nf">buildACSData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the all the needed data from ACS for a tax year and insert it into</span>
<span class="sd">        the local sqlite database.  rollyear is the four digit rollyear</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#if no rollyear is entered use current year</span>
        <span class="k">if</span> <span class="n">rollyear</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rollyear</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="c">#get and set the needed data</span>
        <span class="k">print</span> <span class="s">&#39;start taxdata </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">rollyear</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTaxdata</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setTaxdata</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;total bills =</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">ok</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setACSBillData</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;actual bills = </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">ok</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRealTaxValues</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setRealTaxValues</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;set land values = </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">ok</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRealTaxes</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setRealTaxes</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;set tax due count = </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">ok</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setRealTaxesNet</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>        
        <span class="k">print</span> <span class="s">&#39;update muniTaxdata, utaTaxdata and tidTaxdata tables&#39;</span>
        <span class="n">muni</span><span class="p">,</span><span class="n">uta</span><span class="p">,</span><span class="n">tid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMuniSchoolTaxData</span><span class="p">(</span><span class="mi">2011</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setMuniSchoolTaxData</span><span class="p">(</span><span class="n">muni</span><span class="p">,</span><span class="n">uta</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="mi">2011</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;update bill data&#39;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateACSBillData</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>        
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateBillData</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>        
        <span class="k">print</span> <span class="s">&#39;ACS import for taxyear </span><span class="si">%s</span><span class="s"> done&#39;</span><span class="o">%</span><span class="n">rollyear</span>   
        </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.updateBillStatus"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.updateBillStatus">[docs]</a>    <span class="k">def</span> <span class="nf">updateBillStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;update bill status for all bills&quot;&quot;&quot;</span>
        <span class="c">#set bill status to P (paid) for all bills</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update billData set status=&#39;P&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c">#select all bills with either Active or Deqlinquent</span>
        <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;select b_parcel_id, b_tax_year, b_status, b_alt_pin from lr_bill_attributes where b_bill_type = &#39;RP&#39; and (b_status =&#39;DLQ&#39; or b_status =&#39;A&#39; or b_status=&#39;PP&#39;)&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="c">#set all bills by pin and taxyear to correct status from results</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span><span class="mi">2010</span><span class="p">:</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update billData set status=&#39;</span><span class="si">%s</span><span class="s">&#39; where ComputerNumber=&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear=</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ssql</span> <span class="o">=</span> <span class="s">&quot;update billData set status=&#39;</span><span class="si">%s</span><span class="s">&#39; where PIN=&#39;</span><span class="si">%s</span><span class="s">&#39; and taxyear=</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c">#print ssql</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ssql</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">print</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    </div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.updatePayments"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.updatePayments">[docs]</a>    <span class="k">def</span> <span class="nf">updatePayments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rollyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets all payments made for a rollyear then adds them to the payment</span>
<span class="sd">        table. rollyear is the four digit year</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&#39;update payments for year </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">rollyear</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPayemnts</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setPayments</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">ok</span>
        
        <span class="k">print</span> <span class="s">&#39;update tax payments for P &amp; I calculations&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatePaymentStatus</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsetTaxPayments</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">ok</span>
        
        <span class="k">print</span> <span class="s">&#39;update voided payments&#39;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsetVoids</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&#39;update payment on bill&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getsetBillPayment</span><span class="p">(</span><span class="n">rollyear</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">ok</span>
        <span class="k">return</span>  <span class="n">ok</span>
    <span class="c">############################</span>
    <span class="c">#   MAIN FUNCTION CALLS    #</span>
    <span class="c">############################</span></div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.updateTaxDB"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.updateTaxDB">[docs]</a>    <span class="k">def</span> <span class="nf">updateTaxDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lastyear</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        updates all records in an existing tax db.  must have updated property</span>
<span class="sd">        database. last year is the last tax year to update as a four digit year</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#add 1 year to the year for the loop</span>
        <span class="c">#if not try to convert the data to an integer and add 1 to it</span>
        <span class="c">#if not fail</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lastyear</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">:</span>
            <span class="n">lastyear</span> <span class="o">=</span> <span class="n">lastyear</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lastyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastyear</span><span class="p">)</span>
                <span class="n">lastyear</span> <span class="o">=</span> <span class="n">lastyear</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;error: year input is not integer year&#39;</span>
                <span class="k">return</span>
        <span class="c">#year must be greater than 2010 or not ACS data is present        </span>
        <span class="k">if</span> <span class="n">lastyear</span> <span class="o">&lt;=</span> <span class="mi">2011</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;error: year must be greater than 2011&#39;</span>
            <span class="k">return</span>                
                    
        <span class="c">#update the status for all bills </span>
        <span class="k">print</span> <span class="s">&quot;update bill status&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateBillStatus</span><span class="p">()</span>
        
        <span class="c">#updates payments and status for a roll year.  NOT by payment date or transaction date!!!!</span>
        <span class="c">#must be done for all rollyears with delq accounts</span>
        <span class="c">#as of 02/02/2012 this is 2003.  first time run needs all years</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span><span class="n">lastyear</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;start payment updates&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatePayments</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="mi">2009</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateACSBillData</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;payements, history, Document numbers and status run for </span><span class="si">%s</span><span class="s"> tax year&quot;</span><span class="o">%</span><span class="n">year</span>
            
        <span class="c">#sets the overide for calculation of Interest and Penalty. this flag stops the accumulation of interest or penalty    </span>
        <span class="k">print</span> <span class="s">&quot;update override pen and interest for P &amp; I calculations&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getsetOverride</span><span class="p">()</span>
        <span class="c">#update the db_info with the latest update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;update db_info set lastupdate=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;update completed&#39;</span>
</div>
    <span class="nd">@timed</span>
<div class="viewcode-block" id="Taxdata.createTaxDB"><a class="viewcode-back" href="../../acs_taxes.html#__PyRPL.acs_taxes.Taxdata.createTaxDB">[docs]</a>    <span class="k">def</span> <span class="nf">createTaxDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lastyear</span><span class="o">=</span><span class="mi">2011</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates the initial tax database. needs to have property database to</span>
<span class="sd">        run correctly. last year is the last tax year to be created in the db</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#use last year plus 1 to get all years requested</span>
        <span class="c">#try to make string into int to allow or fail and stop</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lastyear</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">:</span>
            <span class="n">lastyear</span> <span class="o">=</span> <span class="n">lastyear</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lastyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastyear</span><span class="p">)</span>
                <span class="n">lastyear</span> <span class="o">=</span> <span class="n">lastyear</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;error: year input is not integer year&#39;</span>
                <span class="k">return</span>
        <span class="c">#last year must be greater than or equal to 2011  for ACS to update correctly</span>
        <span class="c">#don&#39;t allow if this is not true</span>
        <span class="k">if</span> <span class="n">lastyear</span> <span class="o">&lt;=</span> <span class="mi">2011</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;error: year must be greater than 2011&#39;</span>
            <span class="k">return</span>                
            
        <span class="c">#build the local db from HP extract text files</span>
        <span class="c">#this portion is only for years 2003 to 2010.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildHPData</span><span class="p">()</span>
        
        <span class="c">#this portion is for 2011 forward</span>
        <span class="c">#current setting is for only 2011 tax year forward as it is in ACS</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span><span class="n">lastyear</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buildACSData</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            
        <span class="c">#update the status for all bills </span>
        <span class="k">print</span> <span class="s">&quot;update bill status&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateBillStatus</span><span class="p">()</span>
        
        <span class="c">#updates payments and status for a roll year.  NOT by payment date or transaction date!!!!</span>
        <span class="c">#must be done for all rollyears with delq accounts</span>
        <span class="c">#as of 02/02/2012 this is 2003.  first time run needs all years</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span><span class="n">lastyear</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;start payment updates&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatePayments</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;payements and status run for </span><span class="si">%s</span><span class="s"> tax year&quot;</span><span class="o">%</span><span class="n">year</span>
            
        <span class="c">#sets the overide for calculation of Interest and Penalty. this flag stops the accumulation of interest or penalty    </span>
        <span class="k">print</span> <span class="s">&quot;update override pen and interest for P &amp; I calculations&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getsetOverride</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lconn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;main completed&#39;</span>
        </div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">taxdata</span> <span class="o">=</span> <span class="n">Taxdata</span><span class="p">()</span>
    <span class="c">#lastyear =2012</span>
    
    <span class="c">#build the local db from HP extract text files</span>
    <span class="c">#this portion is only for years 2003 to 2010.</span>
    <span class="n">taxdata</span><span class="o">.</span><span class="n">buildHPData</span><span class="p">()</span>

    <span class="c">#this portion is for 2011 forward</span>
    <span class="c">#current setting is for only 2011 tax year</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span><span class="mi">2012</span><span class="p">):</span>
        <span class="n">taxdata</span><span class="o">.</span><span class="n">buildACSData</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="c">#updates payments and status for a roll year.  NOT by payment date or transaction date!!!!</span>
    <span class="c">#must be done for all rollyears with delq accounts</span>
    <span class="c">#as of 02/02/2012 this is 2003.  first time run needs all years</span>
    <span class="n">taxdata</span><span class="o">.</span><span class="n">updatePayments</span><span class="p">(</span><span class="n">lastyear</span><span class="p">)</span>
    
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Base Modules.html">User Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Foundation Modules</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2012, Matt Kasfeldt.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html> 